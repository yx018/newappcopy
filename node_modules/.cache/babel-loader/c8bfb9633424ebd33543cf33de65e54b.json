{"ast":null,"code":"var _jsxFileName = \"/Users/yangxu/newapp/src/MyComponent.js\",\n    _s = $RefreshSig$();\n\nimport { OpenCvProvider, useOpenCv } from 'opencv-react';\nimport { React, useEffect, useState } from 'react';\nimport './MyComponent.css';\nimport Utils from './Utils';\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\n\nconst cv = require('./opencv2');\n\nconsole.log('head', cv);\n\nfunction MyComponent() {\n  _s();\n\n  const {\n    loaded,\n    cv\n  } = useOpenCv();\n  const [count, setCount] = useState(0);\n  const [videoLoaded, setVideoLoaded] = useState(false);\n  let add_button = document.getElementById(\"add\");\n  let zoom_window_text = document.getElementById(\"zoom_window_text\");\n  let process_window_text = document.getElementById(\"process_window_text\");\n  let video = document.getElementById(\"cam_input\");\n  let output = document.getElementById(\"canvas_output\");\n  let utils = new Utils(); // let video = document.getElementById(\"cam_input\");\n  // let minsize = new cv.Size(0, 0);\n  // let maxsize = new cv.Size(1000, 1000);\n  // let utils = new Utils(faceCascadeFile, faceCascadeFile);\n  // utils.loadOpenCv(initial);\n  // async function initial(){\n  //     src = new cv.Mat(video.height, video.width, cv.CV_8UC4);\n  //      dst = new cv.Mat(video.height, video.width, cv.CV_8UC1);\n  //      gray = new cv.Mat();\n  //      cap = new cv.VideoCapture(\"cam_input\");\n  //      faces = new cv.RectVector();\n  //      classifier = new cv.CascadeClassifier();\n  // }\n  // utils.createFileFromUrl(faceCascadeFile, faceCascadeFile, () => {\n  //     classifier.load(faceCascadeFile); // in the callback, load the cascade from file \n  // })\n  // utils.loadOpenCv();\n  // useEffect(() => {\n  //     if (videoLoaded) {\n  //         openCvReady();\n  //         // setCount(count + 1);\n  //     }\n  // }, [videoLoaded])\n  // useEffect(() => {\n  //     console.log('videoLoaded: ' ,videoLoaded);\n  //     if (videoLoaded) {\n  //         console.log('component useEffect', cv);\n  //         console.log(cap);\n  //         openCvReady();\n  //     }\n  // }, [count])\n  // let classifier;\n\n  const catchZoomWindow = () => {\n    navigator.mediaDevices.getDisplayMedia({\n      video: true,\n      audio: false\n    }).then(function (stream) {\n      video.srcObject = stream;\n      let settings = stream.getVideoTracks()[0].getSettings();\n      console.log(settings);\n      add_button.style.display = \"none\";\n      zoom_window_text.style.display = \"none\";\n      process_window_text.style.display = \"none\"; // FPS = settings.frameRate;\n\n      output.style.width = video.style.width;\n      output.style.height = video.style.height; // video.play();\n    }).then(() => {\n      console.log('component catch', cv);\n    }).then(() => {\n      // openCvReady();\n      utils.loadOpenCv(openCvReady);\n    }).catch(err => {\n      console.log(\"An error occurred! \" + err);\n    });\n  };\n\n  let counter; // console.log(cv.Mat);\n\n  function openCvReady() {\n    // const { loaded, cv } = useOpenCv();\n    console.log('opencvReady', cv.Mat, loaded);\n    let FPS = 0.25; // let video = document.getElementById(\"cam_input\");\n\n    let src = new cv.Mat(video.height, video.width, cv.CV_8UC4);\n    let dst = new cv.Mat(video.height, video.width, cv.CV_8UC1);\n    let gray = new cv.Mat();\n    let cap = new cv.VideoCapture(video);\n    let faces = new cv.RectVector();\n    let classifier = new cv.CascadeClassifier();\n    let minsize = new cv.Size(0, 0);\n    let maxsize = new cv.Size(1000, 1000);\n    let faceCascadeFile = 'haarcascade_frontalface_default.xml';\n    console.log('here');\n    utils.createFileFromUrl(faceCascadeFile, '../haarcascades/' + faceCascadeFile, () => {\n      classifier.load(faceCascadeFile); // in the callback, load the cascade from file\n\n      console.log('AAA');\n    }); // utils.createFileFromUrl(faceCascadeFile, faceCascadeFile, () => {\n    //     classifier.load(faceCascadeFile); // in the callback, load the cascade from file \n    //     // .then(()=>{\n    //     //     console.log('succuess');\n    //     //     // processVideo();\n    //     // })\n    //     // .catch((err)=>{\n    //     //     console.log('load err', err);\n    //     // });\n    //     console.log('AAA');\n    // });\n    // utils.createFileFromUrl(faceCascadeFile, faceCascadeFile, () => {\n    //     classifier.load(faceCascadeFile) // in the callback, load the cascade from file \n    //     .then(()=>{\n    //         console.log('succuess');\n    //     })\n    //     .catch(()=>{\n    //         console.log('load err');\n    //     })\n    // })\n\n    let clip_width = video.width / 5;\n    let clip_height = video.height / 5; // let face_row = -1;\n    // let face_col = -1;\n    // while(true){\n    // }\n\n    function processVideo() {\n      let begin = Date.now();\n\n      if (video.srcObject != null) {\n        cap.read(src);\n        src.copyTo(dst);\n        cv.cvtColor(dst, gray, cv.COLOR_RGBA2GRAY, 0);\n        console.log(classifier.load);\n        console.log(gray);\n        console.log(faces); // try{\n\n        classifier.detectMultiScale(gray, faces, 1.1, 3).then(() => {\n          console.log(\"face size: \" + faces.size());\n        }).catch(err => {\n          console.error(err);\n        }); // console.log(\"face size: \"+ faces.size());\n        // }catch(err){\n        //     console.log(err);\n        // }\n\n        for (let i = 0; i < faces.size(); ++i) {\n          let face = faces.get(i); // console.log(face);\n\n          let face_row = parseInt(face.y / clip_height);\n          let face_col = parseInt(face.x / clip_width);\n          let tmp_row = parseInt((face.y + face.height - 5) / clip_height);\n          let tmp_col = parseInt((face.x + face.width - 5) / clip_width); // console.log([face_row, face_col, tmp_row, tmp_col]);\n\n          if (face.width >= clip_width || face.height >= clip_height || tmp_row != face_row || tmp_col != face_col) continue;\n          let point1 = new cv.Point(face.x, face.y);\n          let point2 = new cv.Point(face.x + face.width, face.y + face.height);\n          cv.rectangle(dst, point1, point2, [255, 0, 0, 255]);\n        }\n\n        cv.imshow(\"canvas_output\", dst);\n      } // schedule next one.\n\n\n      let delay = 1000 / FPS - (Date.now() - begin);\n      setTimeout(processVideo, delay);\n    } // schedule first one.\n\n  } // function Utils() { // eslint-disable-line no-unused-vars\n  //     // const { loaded, cv } = useOpenCv()\n  //     let self = this;\n  //     this.createFileFromUrl = function(path, url, callback) {\n  //         let request = new XMLHttpRequest();\n  //         request.open('GET', url, true);\n  //         request.responseType = 'arraybuffer';\n  //         request.onload = function(ev) {\n  //             if (request.readyState === 4) {\n  //                 if (request.status === 200) {\n  //                     let data = new Uint8Array(request.response);\n  //                     cv.FS_createDataFile('/', path, data, true, false, false);\n  //                     // console.log('request:',request);\n  //                     callback();\n  //                 } else {\n  //                     self.printError('Failed to load ' + url + ' status: ' + request.status);\n  //                 }\n  //             }\n  //         };\n  //         request.send();\n  //     };\n  //     const OPENCV_URL = 'opencv.js';\n  //     this.loadOpenCv = function(onloadCallback) {\n  //         let script = document.createElement('script');\n  //         script.setAttribute('async', '');\n  //         script.setAttribute('type', 'text/javascript');\n  //         script.addEventListener('load', async () => {\n  //             try{\n  //                 if (cv.getBuildInformation())\n  //                 {\n  //                     console.log(cv.getBuildInformation()); //satisfy this condition\n  //                     onloadCallback();\n  //                 }\n  //                 else\n  //                 {\n  //                     // WASM\n  //                     if (cv instanceof Promise) {\n  //                         cv = await cv; \n  //                         console.log(cv.getBuildInformation());\n  //                         onloadCallback();\n  //                     } else {\n  //                         cv['onRuntimeInitialized']=()=>{  \n  //                             console.log(cv.getBuildInformation()); \n  //                             onloadCallback();\n  //                         }\n  //                     }\n  //                 }\n  //             }catch(err){\n  //                 console.log(err);\n  //             }\n  //         });\n  //         script.addEventListener('error', () => {\n  //             self.printError('Failed to load ' + OPENCV_URL);\n  //         });\n  //         script.src = OPENCV_URL;\n  //         let node = document.getElementsByTagName('script')[0];\n  //         node.parentNode.insertBefore(script, node);\n  //     };\n  // }\n\n\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    children: [/*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"container\",\n      children: [/*#__PURE__*/_jsxDEV(\"h2\", {\n        id: \"title\",\n        children: \"iExam\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 287,\n        columnNumber: 13\n      }, this), /*#__PURE__*/_jsxDEV(\"h6\", {\n        id: \"tip\",\n        children: \"Please click add button to import the Zoom stream. Then you can scroll down to the iExam window.\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 288,\n        columnNumber: 13\n      }, this), /*#__PURE__*/_jsxDEV(\"p\", {\n        id: \"zoom_window_text\",\n        children: \"Zoom window\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 289,\n        columnNumber: 13\n      }, this), /*#__PURE__*/_jsxDEV(\"video\", {\n        id: \"cam_input\",\n        width: \"1200\",\n        height: \"690\",\n        autoPlay: true,\n        muted: true\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 290,\n        columnNumber: 13\n      }, this), /*#__PURE__*/_jsxDEV(\"svg\", {\n        xmlns: \"http://www.w3.org/2000/svg\",\n        id: \"add\",\n        onClick: catchZoomWindow,\n        width: \"120\",\n        height: \"120\",\n        viewBox: \"0 0 24 24\",\n        children: /*#__PURE__*/_jsxDEV(\"path\", {\n          d: \"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 292,\n          columnNumber: 133\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 292,\n        columnNumber: 13\n      }, this), /*#__PURE__*/_jsxDEV(\"p\", {\n        id: \"process_window_text\",\n        children: \"iExam window\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 293,\n        columnNumber: 13\n      }, this), /*#__PURE__*/_jsxDEV(\"canvas\", {\n        id: \"canvas_output\",\n        width: \"1200\",\n        height: \"690\",\n        children: \"This box is for capturing student face\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 294,\n        columnNumber: 13\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 286,\n      columnNumber: 9\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"footer\",\n      children: [/*#__PURE__*/_jsxDEV(\"p\", {\n        children: [\"Details for iExam please refer to slides: \", /*#__PURE__*/_jsxDEV(\"a\", {\n          href: \"https://daoyuan14.github.io/slides/Expo21_iExam.pdf\",\n          target: \"_blank\",\n          children: \"https://daoyuan14.github.io/slides/Expo21_iExam.pdf\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 297,\n          columnNumber: 58\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 297,\n        columnNumber: 13\n      }, this), /*#__PURE__*/_jsxDEV(\"p\", {\n        children: [\"Post-exam recording analysis for desktop version, please view: \", /*#__PURE__*/_jsxDEV(\"a\", {\n          href: \"https://github.com/VPRLab/iExam/tree/test\",\n          target: \"_blank\",\n          children: \"https://github.com/VPRLab/iExam/tree/test \"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 298,\n          columnNumber: 79\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 298,\n        columnNumber: 13\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 296,\n      columnNumber: 9\n    }, this), /*#__PURE__*/_jsxDEV(\"script\", {\n      async: true,\n      src: \"opencv2.js\",\n      onLoad: openCvReady,\n      type: \"text/javascript\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 302,\n      columnNumber: 9\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 284,\n    columnNumber: 9\n  }, this);\n}\n\n_s(MyComponent, \"OTTcGvLWi7UfDqSCoyegBYCQNy8=\", false, function () {\n  return [useOpenCv];\n});\n\n_c = MyComponent;\nexport default MyComponent;\n\nvar _c;\n\n$RefreshReg$(_c, \"MyComponent\");","map":{"version":3,"sources":["/Users/yangxu/newapp/src/MyComponent.js"],"names":["OpenCvProvider","useOpenCv","React","useEffect","useState","Utils","cv","require","console","log","MyComponent","loaded","count","setCount","videoLoaded","setVideoLoaded","add_button","document","getElementById","zoom_window_text","process_window_text","video","output","utils","catchZoomWindow","navigator","mediaDevices","getDisplayMedia","audio","then","stream","srcObject","settings","getVideoTracks","getSettings","style","display","width","height","loadOpenCv","openCvReady","catch","err","counter","Mat","FPS","src","CV_8UC4","dst","CV_8UC1","gray","cap","VideoCapture","faces","RectVector","classifier","CascadeClassifier","minsize","Size","maxsize","faceCascadeFile","createFileFromUrl","load","clip_width","clip_height","processVideo","begin","Date","now","read","copyTo","cvtColor","COLOR_RGBA2GRAY","detectMultiScale","size","error","i","face","get","face_row","parseInt","y","face_col","x","tmp_row","tmp_col","point1","Point","point2","rectangle","imshow","delay","setTimeout"],"mappings":"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","sourcesContent":["import { OpenCvProvider, useOpenCv } from 'opencv-react';\nimport {React, useEffect, useState} from 'react'\nimport './MyComponent.css';\nimport Utils from './Utils';\n\nconst cv = require('./opencv2')\n\nconsole.log('head', cv);\n\nfunction MyComponent() {\n\n\n    const { loaded, cv } = useOpenCv();\n\n    const [count, setCount] = useState(0);\n    const [videoLoaded, setVideoLoaded] = useState(false);\n\n    let add_button = document.getElementById(\"add\");\n    let zoom_window_text = document.getElementById(\"zoom_window_text\");\n    let process_window_text = document.getElementById(\"process_window_text\");\n    let video = document.getElementById(\"cam_input\");\n    let output = document.getElementById(\"canvas_output\");\n    \n    let utils = new Utils();\n\n    // let video = document.getElementById(\"cam_input\");\n    \n    // let minsize = new cv.Size(0, 0);\n    // let maxsize = new cv.Size(1000, 1000);\n\n    // let utils = new Utils(faceCascadeFile, faceCascadeFile);\n    // utils.loadOpenCv(initial);\n\n    // async function initial(){\n    //     src = new cv.Mat(video.height, video.width, cv.CV_8UC4);\n    //      dst = new cv.Mat(video.height, video.width, cv.CV_8UC1);\n    //      gray = new cv.Mat();\n    //      cap = new cv.VideoCapture(\"cam_input\");\n    //      faces = new cv.RectVector();\n    //      classifier = new cv.CascadeClassifier();\n    // }\n\n    // utils.createFileFromUrl(faceCascadeFile, faceCascadeFile, () => {\n    //     classifier.load(faceCascadeFile); // in the callback, load the cascade from file \n    // })\n\n    \n    // utils.loadOpenCv();\n\n    // useEffect(() => {\n    //     if (videoLoaded) {\n    \n    //         openCvReady();\n\n    //         // setCount(count + 1);\n    //     }\n    // }, [videoLoaded])\n    \n    // useEffect(() => {\n    //     console.log('videoLoaded: ' ,videoLoaded);\n    //     if (videoLoaded) {\n    //         console.log('component useEffect', cv);\n    //         console.log(cap);\n    //         openCvReady();\n    //     }\n    // }, [count])\n\n    // let classifier;\n\n\n    const catchZoomWindow = () => {\n        navigator.mediaDevices.getDisplayMedia({ video: true, audio: false })\n        .then(function(stream) {\n        video.srcObject = stream;\n        let settings = stream.getVideoTracks()[0].getSettings();\n        console.log(settings);\n        add_button.style.display = \"none\";\n        zoom_window_text.style.display = \"none\";\n        process_window_text.style.display = \"none\";\n        // FPS = settings.frameRate;\n        output.style.width = video.style.width;\n        output.style.height = video.style.height;\n        // video.play();\n        })\n        .then(()=>{\n            console.log('component catch', cv);\n\n        })\n        .then(()=> {\n            // openCvReady();\n            utils.loadOpenCv(openCvReady);\n            \n        })\n        .catch((err) =>{\n            console.log(\"An error occurred! \" + err);\n        });\n\n    }\n\n    let counter;\n    \n    \n    // console.log(cv.Mat);\n\n    function openCvReady() {\n        // const { loaded, cv } = useOpenCv();\n        \n        console.log('opencvReady', cv.Mat, loaded);\n    \n        let FPS = 0.25;\n        // let video = document.getElementById(\"cam_input\");\n        let src = new cv.Mat(video.height, video.width, cv.CV_8UC4);\n        let dst = new cv.Mat(video.height, video.width, cv.CV_8UC1);\n        let gray = new cv.Mat();\n        let cap = new cv.VideoCapture(video);\n        let faces = new cv.RectVector();\n        let classifier = new cv.CascadeClassifier();\n        let minsize = new cv.Size(0, 0);\n        let maxsize = new cv.Size(1000, 1000);\n        let faceCascadeFile = 'haarcascade_frontalface_default.xml';\n        \n        console.log('here');\n\n        utils.createFileFromUrl(faceCascadeFile, '../haarcascades/'+faceCascadeFile, () => {\n            classifier.load(faceCascadeFile); // in the callback, load the cascade from file\n            console.log('AAA'); \n        });\n\n       \n        // utils.createFileFromUrl(faceCascadeFile, faceCascadeFile, () => {\n        //     classifier.load(faceCascadeFile); // in the callback, load the cascade from file \n        //     // .then(()=>{\n        //     //     console.log('succuess');\n        //     //     // processVideo();\n        //     // })\n        //     // .catch((err)=>{\n        //     //     console.log('load err', err);\n        //     // });\n        //     console.log('AAA');\n        // });\n        \n        \n    \n    \n        // utils.createFileFromUrl(faceCascadeFile, faceCascadeFile, () => {\n        //     classifier.load(faceCascadeFile) // in the callback, load the cascade from file \n        //     .then(()=>{\n        //         console.log('succuess');\n        //     })\n        //     .catch(()=>{\n        //         console.log('load err');\n        //     })\n        // })\n        \n    \n        let clip_width = video.width/5;\n        let clip_height = video.height/5;\n        \n    \n        // let face_row = -1;\n        // let face_col = -1;\n    \n        // while(true){\n    \n        // }\n        \n        function processVideo() {\n            let begin = Date.now();\n            if (video.srcObject!=null){\n                cap.read(src);\n                src.copyTo(dst);\n                cv.cvtColor(dst, gray, cv.COLOR_RGBA2GRAY, 0);\n                console.log(classifier.load);\n                console.log(gray);\n                console.log(faces);\n                \n    \n                // try{\n                    classifier.detectMultiScale(gray, faces, 1.1, 3)\n                    .then(()=>{\n                        console.log(\"face size: \"+ faces.size());\n                    })\n                    .catch((err)=>{\n                        console.error(err);\n                    });\n                    // console.log(\"face size: \"+ faces.size());\n                // }catch(err){\n                //     console.log(err);\n                // }\n                for (let i = 0; i < faces.size(); ++i) {\n                    let face = faces.get(i);\n                    // console.log(face);\n                    let face_row = parseInt(face.y/clip_height);\n                    let face_col = parseInt(face.x/clip_width);\n    \n                    let tmp_row = parseInt((face.y+face.height-5) / clip_height);\n                    let tmp_col = parseInt((face.x+face.width-5) / clip_width);\n                    // console.log([face_row, face_col, tmp_row, tmp_col]);\n                    if (face.width>=clip_width || face.height>=clip_height || tmp_row!=face_row || tmp_col!=face_col)\n                        continue;\n    \n                    let point1 = new cv.Point(face.x, face.y);\n                    let point2 = new cv.Point(face.x + face.width, face.y + face.height);\n                    cv.rectangle(dst, point1, point2, [255, 0, 0, 255]);\n                }\n                cv.imshow(\"canvas_output\", dst);\n            }\n            // schedule next one.\n            let delay = 1000/FPS - (Date.now() - begin);\n            setTimeout(processVideo, delay);\n        }\n        // schedule first one.\n        \n        \n    }\n\n    // function Utils() { // eslint-disable-line no-unused-vars\n\n    //     // const { loaded, cv } = useOpenCv()\n        \n    //     let self = this;\n    //     this.createFileFromUrl = function(path, url, callback) {\n    //         let request = new XMLHttpRequest();\n    //         request.open('GET', url, true);\n    //         request.responseType = 'arraybuffer';\n    //         request.onload = function(ev) {\n    //             if (request.readyState === 4) {\n    //                 if (request.status === 200) {\n    //                     let data = new Uint8Array(request.response);\n    //                     cv.FS_createDataFile('/', path, data, true, false, false);\n    //                     // console.log('request:',request);\n    //                     callback();\n    //                 } else {\n    //                     self.printError('Failed to load ' + url + ' status: ' + request.status);\n    //                 }\n    //             }\n    //         };\n    //         request.send();\n    //     };\n    \n    //     const OPENCV_URL = 'opencv.js';\n    //     this.loadOpenCv = function(onloadCallback) {\n    //         let script = document.createElement('script');\n    //         script.setAttribute('async', '');\n    //         script.setAttribute('type', 'text/javascript');\n    //         script.addEventListener('load', async () => {\n    //             try{\n    //                 if (cv.getBuildInformation())\n    //                 {\n    //                     console.log(cv.getBuildInformation()); //satisfy this condition\n    //                     onloadCallback();\n    //                 }\n    //                 else\n    //                 {\n    //                     // WASM\n    //                     if (cv instanceof Promise) {\n    //                         cv = await cv; \n    //                         console.log(cv.getBuildInformation());\n    //                         onloadCallback();\n    //                     } else {\n    //                         cv['onRuntimeInitialized']=()=>{  \n    //                             console.log(cv.getBuildInformation()); \n    //                             onloadCallback();\n    //                         }\n    //                     }\n    //                 }\n    //             }catch(err){\n    //                 console.log(err);\n    //             }\n    //         });\n    //         script.addEventListener('error', () => {\n    //             self.printError('Failed to load ' + OPENCV_URL);\n    //         });\n    //         script.src = OPENCV_URL;\n    //         let node = document.getElementsByTagName('script')[0];\n    //         node.parentNode.insertBefore(script, node);\n    //     };\n    // }\n    \n\n\n\n    return (\n        <div>\n        {/* <OpenCvProvider onLoad={onLoaded} openCvPath='./opencv.js'> */}\n        <div className=\"container\">\n            <h2 id=\"title\">iExam</h2>\n            <h6 id=\"tip\">Please click add button to import the Zoom stream. Then you can scroll down to the iExam window.</h6>\n            <p id=\"zoom_window_text\">Zoom window</p>\n            <video id=\"cam_input\" width=\"1200\" height=\"690\" autoPlay muted></video>\n            {/* <img id=\"add\" src=\"add.svg\" alt=\"upload video window\" width=\"128\" height=\"128\" /> */}\n            <svg xmlns=\"http://www.w3.org/2000/svg\" id=\"add\" onClick={catchZoomWindow} width=\"120\" height=\"120\" viewBox=\"0 0 24 24\"><path d=\"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z\"/></svg>\n            <p id=\"process_window_text\">iExam window</p>\n            <canvas id=\"canvas_output\" width=\"1200\" height=\"690\">This box is for capturing student face</canvas>\n        </div>\n        <div className=\"footer\">\n            <p>Details for iExam please refer to slides: <a href=\"https://daoyuan14.github.io/slides/Expo21_iExam.pdf\" target=\"_blank\">https://daoyuan14.github.io/slides/Expo21_iExam.pdf</a></p>\n            <p>Post-exam recording analysis for desktop version, please view: <a href=\"https://github.com/VPRLab/iExam/tree/test\" target=\"_blank\">https://github.com/VPRLab/iExam/tree/test </a></p>\n            {/* <p id=\"author\">Author: YANG Xu, Supervisor: WU Daoyuan (VPRLab)</p>\n            <p>Last Modified: Mon Oct 25 2021 23:12:29 GMT+0800 (Hong Kong Standard Time)</p> */}\n        </div>\n        <script async src=\"opencv2.js\" onLoad={openCvReady} type=\"text/javascript\"></script>\n        \n        </div>\n    )\n\n}\n\n\n\n\n\n\nexport default MyComponent;"]},"metadata":{},"sourceType":"module"}